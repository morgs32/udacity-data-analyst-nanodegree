---
title: "p4"
output: html_document
---



```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
echo=FALSE, warning=FALSE, message=FALSE)
```




```{r, echo=FALSE}

## Setup

# setwd('<path to folder>/p4')
# install.packages("ggplot2")
# install.packages("knitr", dependencies = T)
# install.packages("dplyr", dependencies = T)
# install.packages("GGally", dependencies = T)
# library(ggplot2)
# library

#getwd()
setwd('/Users/Morgan/Github/udacity-data-analyst-nanodegree/p4')

library(ggplot2)
library(GGally)
library(grid)
library(gridExtra)


## Load the data:

df <- read.csv('wineQualityReds.csv')

```

# Introduction

## About the data

This tidy data set contains 1,599 red wines with 11 variables on the chemical properties of the wine. At least 3 wine experts rated the quality of each wine, providing a rating between 0 (very bad) and 10 (very excellent).

## Guiding question

- Which chemical properties influence the quality of red wines?

## Initial observations

First we'll check out the structure and schema of the data set:

```{r}
str(df)
summary(df)
```


*Note* X is just the id or row number.

It's interesting to noe the min and max values for some of the chemical properties. Density is between .9901 and 1.0037, while total sulfur dioxide ranges from 6 to 289.

We are primarily interested in wine quality, which ranges from 3 - 8. The median is 6 and the average quality rating is 5.636.


# Plots

Let's do some plots!


## Univariate Analysis


```{r echo=FALSE}

# Function that get a basic histogram with a default binwidth of range/30
get_basic_histogram <- 
  function(column, data, binwidth = diff(range(data[column]))/30) {
    return(ggplot(aes_string(x = column), data = data) + 
             geom_histogram(binwidth = binwidth))
  }

get_basic_histogram("quality", df)

```

### Distribution of Quality

It appears to be a normal distribution of quality.

```{r }

get_basic_histogram("quality", df)

```

The "quality" of each wine is one of 6 discrete values: 4, 5, 6, 7, 8.



```{r }

get_basic_histogram("fixed.acidity", df)
get_basic_histogram("volatile.acidity", df, 0.1)
get_basic_histogram("citric.acid", df)
get_basic_histogram("residual.sugar", df)
get_basic_histogram("chlorides", df)
get_basic_histogram("free.sulfur.dioxide", df)
get_basic_histogram("total.sulfur.dioxide", df)
get_basic_histogram("density", df)
get_basic_histogram("pH", df)
get_basic_histogram("sulphates", df)
get_basic_histogram("alcohol", df)
get_basic_histogram("quality", df, 1)

```



## Bivariate Analysis


### Quality by Alcohol

Now, let's look at the variables I thought might have a linear relationship with quality.

``` {r Quality by Alcohol Scatterplot}
ggplot(data = df,
       aes(x = alcohol, y = quality)) +
  geom_point() + 
  scale_x_continuous() + 
  scale_y_continuous() +
  ggtitle('Quality by Alcohol')
```

Looks like overplotting. So let's add some jitter and transparency to the points:

``` {r Quality by Alcohol with Jitter and Transparency}
ggplot(data = df,
       aes(x = alcohol, y = quality)) +
  geom_point(position = 'jitter', alpha = 0.5, size = 0.75) + 
  scale_x_continuous() + 
  scale_y_continuous() +
  ggtitle('Quality by Alcohol with Jitter and Transparency')
```

Looks like overplotting. So let's add some jitter and transparency to the points:

``` {r Quality by Alcohol with Jitter and Transparency with a Regression}
ggplot(data = df,
       aes(x = alcohol, y = quality)) +
  geom_point(position = 'jitter', alpha = 0.5, size = 0.75) + 
  scale_x_continuous() + 
  scale_y_continuous() +
  ggtitle('Quality by Alcohol with Jitter and Transparency and a Regression') +
  geom_smooth(method='lm',formula=y~x)
```


### Box plots


Thanks to feedback from the reviewer of my first submission, let's try a box plot instead of a scatter plot.

``` {r Quality by Alcohol}
ggplot(data = df,
       aes(x = factor(quality), y = alcohol)) +
  geom_boxplot() + 
  ggtitle('Quality by Alcohol')
```

Box plots are definitely the way to go. Noticable correlation: higher rated wines have higher alcohol content.


#### Quality by Density

From looking at the plot below, I'm not so sure about the linear relationship

``` {r Quality by Density with Jitter and Transparency}

ggplot(data = df,
       aes(x = factor(quality), y = density)) +
  geom_boxplot() + 
  ggtitle('Quality by Density with Jitter')

```

Weak correlation apparent.

#### Quality by Volatile Acidity

There might still be a linear relationship here

``` {r Quality by Volatile Acidity with Jitter and Transparency}
ggplot(data = df,
       aes(x = factor(quality), y = volatile.acidity)) +
  geom_boxplot() + 
  ggtitle('Quality by Volatile Acidity with Jitter and Transparency')
```

Looks like there is correlation, the lower the volatile acidity, the better the wine.


#### Quality by Sulphates

There might still be a linear relationship here

``` {r Quality by Sulphates with Jitter and Transparency}
ggplot(data = df,
       aes(x = factor(quality), y = sulphates)) +
  geom_boxplot() + 
  ggtitle('Quality by Sulphates with Jitter and Transparency')
```

Lots of outliers, weak but positive correlation.




### Correlation matrix

Let's get a quick look at the correlation between all variable pairs


```{r }
ggcorr(df)
```

Looks like strong positive correlations between quality and alcohol. Fairly significant positive correlation between quality and sulphates (We will explore this later). And strong negative correlations between quality and volatile.acidity.



### New Variable

I created a new variable "rating" has 3 values: bad, average, good

``` {r}
df$rating <- ifelse(df$quality < 5, 'bad', ifelse(
  df$quality < 7, 'average', 'good'))
df$rating <- ordered(df$rating,
                     levels = c('bad', 'average', 'good'))
summary(df$rating)
```


Now let's recreate those box plots with the rating instead of the quality variable

### Grid of boxplots with variables against new variable Rating


``` {r Boxplots against ratings}

p1 <- ggplot(data = df,
     aes(x = rating, y = alcohol)) +
  geom_boxplot() + 
  ggtitle('Rating by Alcohol')

p2 <- ggplot(data = df,
       aes(x = rating, y = density)) +
  geom_boxplot() + 
  ggtitle('Rating by Density')


p3 <- ggplot(data = df,
       aes(x = rating, y = volatile.acidity)) +
  geom_boxplot() + 
  ggtitle('Rating by Volatile Acidity')


p4 <- ggplot(data = df,
       aes(x = rating, y = sulphates)) +
  geom_boxplot() + 
  ggtitle('Rating by Sulphates')

grid.arrange(p1, p2, p3, p4)

```

No big suprises here.


### Multivariate Analysis


Now let's look at density and alcohol against ratings:

```{r}

model <- lm(density ~ alcohol + rating, data=df)
grid <- with(df, expand.grid(
  alcohol = seq(min(alcohol), max(alcohol)),
  rating = levels(rating)
))

grid$density <- stats::predict(model, newdata=grid)


ggplot(data = df,
       aes(y = density, x = alcohol,
           color = rating)) +
  geom_point() +
  scale_color_brewer() + geom_line(data=grid)


```

#### Note: Added a regression line after review of prior submission

It seems that as alcohol content increases, density decreases. Perhaps alcohol, by nature is more dense than the ingredients of wine? This last plot also indicates that, holding alcohol constant, density does not affect quality.


``` {r}

ggplot(data = df,
       aes(y = sulphates, x = floor(alcohol),
           color = quality)) +
  geom_point() +
  scale_y_continuous(limits=c(0.3,1.5)) +
  scale_fill_gradient(low="green",high="darkgreen")

```

This makes me think that if you hold alcohol constant, then more sulphates improves the quality of the wine.



## Final Plots


### Plot one

``` {r}


model <- lm(sulphates ~ alcohol + rating, data=df)
grid <- with(df, expand.grid(
  alcohol = seq(min(alcohol), max(alcohol)),
  rating = levels(rating)
))

grid$sulphates <- stats::predict(model, newdata=grid)

ggplot(data = df,
       aes(y = sulphates, x = alcohol,
           color = rating)) +
  geom_point() +
  scale_y_continuous(limits=c(0.3,1.5)) +
  ylab("potassium sulphate (g/dm3)") +
  xlab("alcohol (% by volume)") +
  scale_color_brewer() +
  geom_line(data=grid) + 
  ggtitle("Alcohol and sulphates over wine quality")

```

What I did learn is that while there may be a correlation between alcohol and quality, or sulphates and quality (see correlation matrix above), there is little or no correlation between alcohol and sulphates.


## Plot two: Quality by Acidic Attributes

``` {r}
grid.arrange(ggplot(data = df, aes(x = factor(quality), y = fixed.acidity)) + 
               ylab('Fixed Acidity') +
               xlab('Quality') +
               geom_boxplot(),
             ggplot(data = df, aes(x = factor(quality), y = volatile.acidity)) +
               ylab('Volatile Acidity') +
               xlab('Quality') +
               geom_boxplot(), 
             ggplot(data = df, aes(x = factor(quality), y = citric.acid)) +
               ylab('Citric Acid') +
               xlab('Quality') +
               geom_boxplot(), 
             ggplot(data = df, aes(x = factor(quality), y = pH)) +
               ylab('pH') +
               xlab('Quality') +
               geom_boxplot())

```


This shows that there is a stronger correlation between quality and volatile acidity and citric acid then there is between quality and fixed acidity and pH.


## Plot three: Model


```{r, echo=FALSE}

# ?lm
library(memisc)

```

``` {r}


m1 <- lm(quality ~ alcohol, data = df)
m2 <- update(m1, ~ . + sulphates)
m3 <- update(m2, ~ . + citric.acid)
m4 <- update(m3, ~ . + volatile.acidity)
m5 <- update(m4, ~ . + fixed.acidity)
mtable(m1, m2, m3, m4, m5)


```

The R squared value of m5 is 0.3. Which means that our regression model only explains around 30% of the variance in quality. It seems we are missing the information that would better predict the quality of wine.

```{r, echo=FALSE}

# ?lm
# install.packages("memisc")
library(dplyr)

```

``` {r}

set.seed(87654321)
training_data <- sample_frac(df, .6)
test_data <- df[ !df$X %in% training_data$X, ]

results <- data.frame(
  test_data$quality,
  predict(m5, test_data) - as.numeric(test_data$quality)
)
names(results) <- c("quality", "error")
ggplot(data=results, aes(x=quality,y=error)) +
  geom_point()
```

The residual plot indicates wide swings in error.

Judging by the regression model, there must be some key information missing that might better predict quality.



## Reflection

From looking at the initial ggpairs plot, it did seem that there was some correlation between quality and a couple variables provided by the data set, namely: alcohol, sulphates, citric.acid, fixed.acidity, and volatile.acidity. Density may have been another variable we could have used in our model.

From looking at the distributions of chemical variables, many had ver long tails and skewed distributions. Only a couple had normal distributions (density, pH).

For many variables, a scatterplot against quality did not indicate much. Even after adding jitter to account for overplotting.

For future studies, it would be helpful to have any additional ingredients. Also, if it were possible to segment the wines, we could hold constant certain qualities - I'm no wine expert, but I believe cabernets probably have different chemicals than merlots, etc.

Another consideration: we cannot account for taste. We do not know who the tasters are. Certainly, different people taste things differently, and that may account for varying quality ratings.

What I did learn is that wines with high alcohol and sulphates do tend to be rated higher. So, those are ingredients I will look for when making my next wine purchase.






